<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>申请新风</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/apply-xinfeng.css">
    <!--标准mui.css-->
    <link rel="stylesheet" href="/css/mui/mui.min.css">
    <!--App自定义的css-->
    <link href="/css/mui/mui.picker.css" rel="stylesheet" />
    <link href="/css/mui/mui.poppicker.css" rel="stylesheet" />
    <script src="/js/jquery-1.9.1.js"></script>
    <script src="/js/mui/mui.min.js"></script>
    <script src="/js/mui/mui.picker.js"></script>
    <script src="/js/mui/mui.poppicker.js"></script>
    <script src="/js/city.data-3all.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var cityPicker3;
        (function($, doc) {
            $.init();
            $.ready(function() {
                //					//级联示例
                cityPicker3 = new $.PopPicker({
                    layer: 3
                });
                cityPicker3.setData(cityData3);
                
                var showCityPickerButton = doc.getElementById('showCityPicker3');
                var cityResult3 = doc.getElementById('cityResult3');
                showCityPickerButton.addEventListener('tap', function(event) {
                    cityPicker3.show(function(items) {
                        cityResult3.innerText = (items[0] || {}).text + " " + (items[1] || {}).text + " " + (items[2] || {}).text;
                        //返回 false 可以阻止选择框的关闭
                        //return false;
                    });
                }, false);
            });
        })(mui, document);
        function OrderCreate(){

            var items=cityPicker3.getSelectedItems();
            var ProID=items[0].value;
            var CityID=items[1].value;
            var DisID=items[2].value;
            var ProTxt=items[0].text;
            var CityTxt=items[1].text;
            var DisTxt=items[2].text;
            if(ProID==''||CityID==''||DisID==''){
                $('#d_msg').removeClass('hide');
                $('#d_msg').text('请选择省份城市');
                return;
            }
            var Address =$('#Address').val();
            if(Address==""){
                $('#d_msg').removeClass('hide');
                $('#d_msg').text('请选择输入详细地址');
                return;
            }
            var SmsCode =$('#RealName').val();
            if(SmsCode==""){
                $('#d_msg').removeClass('hide');
                $('#d_msg').text('请输入申请人');
                return;
            }

            var SmsCode =$('#div_smscode').val();
            if(SmsCode==""){
                $('#d_msg').removeClass('hide');
                $('#d_msg').text('请输入验证码');
                return;
            }
            $("#submitBtn").attr('disabled',true);
            $("#submitBtn").addClass('disabled');
            $.ajax({
                url: '/api/OrderCreate/?rn='+ Math.random(),// 跳转到 action    
                data: {
                        OpenID:"oQKH5v9mHZXY5zPS-9ltkKevFpyQ",
                        ProID:ProID,
                        ProTxt:ProTxt,
                        CityID:CityID,
                        CityTxt:CityTxt,
                        DisID:DisID,
                        DisTxt:DisTxt,
                        Address:$('#Address').val(),
                        RealName:$('#RealName').val(),
                        Mobile:$('#mobile').val(),
                        SmsCode:$("#div_smscode").val(),
                        Timespan:"123456"
                },
                type: 'post',
                dataType: 'json',
                success: function (data) {
                    if(data.Status==1){
                        window.location.href='/wechatPage/ApplySuccess/?OpenID=oQKH5v9mHZXY5zPS-9ltkKevFpyQ&rn='+ Math.random();
                    }else{
                        $('#d_msg').removeClass('hide');
                        $('#d_msg').text('订单提交失败：'+data.Reason);
                        $("#submitBtn").attr('disabled',false);
                        $("#submitBtn").removeClass('disabled');
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                }
            });
        }


        $(function () {
            $('#mobile').bind('input propertychange', function() {
                $('#d_msg').addClass('hide');
                var mobileVal = $("#mobile").val();
                var re = new RegExp("^1([34578][0-9]{9})$");
                    if (re.exec(mobileVal)){
                        $("#identifyingCode").attr('disabled',false);
                        $("#identifyingCode").removeClass('disabled');
                        $('#d_msg').addClass('hide');
                    }else{
                        $("#identifyingCode").attr('disabled',true);
                        $("#identifyingCode").addClass('disabled');
                        $('#d_msg').removeClass('hide');
                        $('#d_msg').text('手机号码格式错误');
                    }
                if($('#identifyingCode').val() != "获取验证码"){
                    $("#identifyingCode").addClass('disabled');
                }


                if(mobileVal.length == 0){
                    $('#d_msg').addClass('hide');
                }else if(mobileVal.length == 11){
                    if($('#identifyingCode').val() != "获取验证码"){
                        $("#identifyingCode").attr('disabled',true);
                        $("#identifyingCode").addClass('disabled');
                    }else{
                        $("#identifyingCode").attr('disabled',false);
                        $("#identifyingCode").removeClass('disabled');
                    }

                }
            })
            $('#div_smscode').bind('input propertychange', function() {
                var divSmscode = $("#div_smscode").val();
                if (divSmscode.length == 4){
                    $("#submitBtn").attr('disabled',false);
                }else{
                    $("#submitBtn").attr('disabled',true);
                }
            })


            $("#identifyingCode").on("click",function () {
                var that = $(this);
                $('#d_msg').addClass('hide');
                var Mobile =$('#mobile').val();
                if(Mobile==""){
                    $('#d_msg').removeClass('hide');
                    $('#d_msg').text('请输入手机号码');
                    return;
                }
                $.ajax({
                    url: '/api/getSmsCode/?rn='+ Math.random(),// 跳转到 action
                    data: {
                        Mobile: Mobile,
                        smsType: 1,
                        Timespan:"123456"
                    },
                    type: 'post',
                    dataType: 'json',
                    success: function (data) {
                        if(data.Status==1){
                            settime(that)
                            mui.toast('发送验证码成功');

                        }else{
                            $('#d_msg').removeClass('hide');
                            $('#d_msg').text(data.Reason);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                    }
                });
            })

            var countdown=70;
            function settime(obj) {
                if (countdown == 0) {
                    obj.attr('disabled',false);
                    obj.removeClass('disabled');
                    obj.val("获取验证码");
                    countdown = 70;
                    return;
                } else {
                    obj.attr('disabled',true);
                    obj.addClass('disabled');
                    obj.val("重新发送(" + countdown + ")");
                    countdown--;
                }
                setTimeout(function() {
                            settime(obj) }
               ,1000)
            }



        })
    </script>
</head>
<body>

<section class="apply-xinfeng-page">
    <!--错误信息提示处-->
    <div id="d_msg" class="error-msg hide"></div>  <!--注意隐藏时候不要用display：none，用透明度或者别的方法-->
    <div class="top-text">
        <p>为工作人员快速为您提供服务 <br>
            请填写真实有效的信息</p>
    </div>
    <p class="line-container" id="showCityPicker3"><em>所在城市</em><span class="area" id="cityResult3">北京市 北京  东城区</span></p>
    <p class="line-container" style=" height: 65px;"><em style="display:block;line-height: 38px;">详细住址</em><textarea type="text" id="Address" placeholder="请输入详细住址" ></textarea></p>
    <p class="line-container"><em>申请人</em><input type="text" id="RealName" placeholder="请输入申请人姓名"  maxlength='10'></p>
    <p class="line-container"><em>手机号</em><input type="text" id="mobile" placeholder="请输入手机号" maxlength='11' style=" ime-mode: disabled;"></p>
    <p class="line-container"><em>验证码</em><input class="code" id="div_smscode"  type="text" placeholder="请输入验证码"  maxlength='4' ime-mode: disabled;><input class="identifying-code disabled" id="identifyingCode" type="button" value="获取验证码" disabled></p>

    <input type="button" id="submitBtn" class="submit-btn" disabled onclick="OrderCreate()" value="提交申请">
</section>

    <input type="hidden" id="OpenID" value="oQKH5v9mHZXY5zPS-9ltkKevFpyQ" >   
</body>
</html>
